<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title></title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width">
  <link rel="stylesheet" href="css/normalize.min.css">
  <link rel="stylesheet" href="css/main.css">

  <script src="js/vendor/modernizr-2.6.1.min.js"></script>
</head>
<body>
  <!--[if lt IE 7]>
      <p class="chromeframe">You are using an outdated browser. <a href="http://browsehappy.com/">Upgrade your browser today</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to better experience this site.</p>
  <![endif]-->

  <canvas id="canvas_cam" width="640" height="480"></canvas>
  <video id="video_cam" width="640" height="480" style="display:none;"></video>

  <script src="js/vendor/jquery-1.8.0.min.js"></script>
  <!-- <script src="js/vendor/trackingjs/tracking.js"></script>
  <script src="js/vendor/trackingjs/tracker/color.js"></script> -->

  <script src="js/main.js"></script>
  <script>

  /*requestAnimationFrame shield*/
(function() {
    var lastTime = 0;
    var vendors = ['ms', 'moz', 'webkit', 'o'];
    for(var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
        window.requestAnimationFrame = window[vendors[x]+'RequestAnimationFrame'];
        window.cancelAnimationFrame = 
          window[vendors[x]+'CancelAnimationFrame'] || window[vendors[x]+'CancelRequestAnimationFrame'];
    }
 
    if (!window.requestAnimationFrame)
        window.requestAnimationFrame = function(callback, element) {
            var currTime = new Date().getTime();
            var timeToCall = Math.max(0, 16 - (currTime - lastTime));
            var id = window.setTimeout(function() { callback(currTime + timeToCall); }, 
              timeToCall);
            lastTime = currTime + timeToCall;
            return id;
        };
 
    if (!window.cancelAnimationFrame)
        window.cancelAnimationFrame = function(id) {
            clearTimeout(id);
        };
}());




/*gUMShield*/
window.URL || (window.URL = window.webkitURL || window.msURL || window.oURL);
//normalize navigator.getUserMedia
navigator.getUserMedia || (navigator.getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia);

var _getUserMedia = function(opts, success, fail) {
    if (!navigator.getUserMedia) fail(new Error("getUserMedia not supported"));

    try {
      navigator.getUserMedia(opts, success, fail);
    } catch (e) {
      var stringopts = [];
      for (var i in opts) {
        if (opts[i] == true) {
          stringopts.push(i);
        }
      }
      stringopts = stringopts.join(",");
      try {
        navigator.getUserMedia(stringopts, success, fail);
      } catch (e) {
        fail(new Error("getUserMedia not supported"));
      }
    }
  };

window.count = 0;
var Start = function(){
    //if(window.count>1)
      //return;
    //console.log("hey");
    var ctx = window.ctx,
        video = window.video,
        canvas = window.canvas;
    requestAnimationFrame(Start); 
    //setInterval(Start,100);
    ctx.drawImage(video, 0, 0, video.width, video.height, 0, 0, canvas.width, canvas.height);
    //if(window.count === 0){
      var i = ctx.getImageData(0, 0, canvas.width, canvas.height),
          data = i.data;
      var r,g,b,a;
      for (var y = 0, h = canvas.height; y < h; ++y) {
          for (var x = 0; x < canvas.width; ++x) {
              var index = (y * canvas.width + x) * 4;
              
              var range = 90;
              if(data[r = index] >= (255 - range) && data[g = ++index] >= (255 - range) && data[b = ++index] >= (255 - range) ){
              //if(data[r = index] === (255 - range) && data[g = ++index] === (255 - range) && data[b = ++index] === (255 - range) ){
              //if(data[r = index] === 255 && data[g = ++index] === 255 && data[b = ++index] === 255 ){
                //console.log("ACHEI O PIXEL BRANCOOOOOOOOOOOoo!");
                data[r] = 127;
                data[g] = 255;
                data[b] = 212;
                data[a] = 255;                
                //console.log("PINTEI O PIXEL!");
              } else if(data[r = index] >= (150 - range) && data[g = ++index] >= (100 - range) && data[b = ++index] >= (100 - range) ){
                
              //if(data[r = index] === (255 - range) && data[g = ++index] === (255 - range) && data[b = ++index] === (255 - range) ){
              //if(data[r = index] === 255 && data[g = ++index] === 255 && data[b = ++index] === 255 ){
                //console.log("ACHEI O PIXEL BRANCOOOOOOOOOOOoo!");
                data[r] = (data[r] + 80) & 0xff;
                //data[g] = 255;
                //data[b] = 212;
                data[a] = 255;                
                //console.log("PINTEI O PIXEL!");
              }


              //data[index] = 50 & 0xff;
              /*var index = (y * canvas.width + x) * 4;

              var value = x * y & 0xff;

              data[index]   = value;    // red
              data[++index] = value;    // green
              data[++index] = value;    // blue
              data[++index] = 255;      // alpha*/
          }
      }
      ctx.putImageData(i, 0, 0);
      window.count++;  
    //}
    
};

var successCallback = function(media) {
    console.log('------------success');
    console.log(media);
    console.log(window.video);
    var video = document.querySelector('#video_cam');
    /*TODO - normalizar URL object, firefox (na minha build do nightly) n√£o necessita o uso o URL object*/
    video.src = media;//firefox
    //video.src = window.URL.createObjectURL(media); //chrome
    video.play();
    var canvas = document.querySelector("#canvas_cam");
    var ctx = canvas.getContext('2d');    
    window.ctx = ctx;
    window.video = video;
    window.canvas = canvas;     
    Start();
    /*setInterval(function() {
      ctx.drawImage(video, 0, 0, video.width, video.height, 0, 0, canvas.width, canvas.height);
    }, 67);*/

  };

var errorCallback = function(error) {
    console.log('------------error');
    console.log(error);
  };

_getUserMedia({
  video: true
}, successCallback, errorCallback);

  </script>
</body>
</html>